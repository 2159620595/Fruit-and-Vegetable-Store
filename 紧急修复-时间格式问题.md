# 紧急修复：时间仍然显示为 ISO 格式

## 问题现象

前端接收到的时间格式是：`2025-10-21T04:18:45.000Z`

这是 ISO 8601 格式的 UTC 时间，说明 Node.js 的 mysql2 驱动返回了 Date 对象，Express 在序列化 JSON 时自动转换了。

## 根本原因

1. MySQL 的 `DATE_FORMAT()` 函数返回的仍然可能被 mysql2 驱动识别为 Date 类型
2. Node.js 在 `JSON.stringify()` 时会自动调用 Date 对象的 `toISOString()` 方法
3. 导致我们格式化的时间字符串又变回了 ISO 格式

## 解决方案

### 方案 1：SQL 强制转换为字符串（已实施）

在 SQL 查询中使用 `CAST(... AS CHAR)` 强制转换：

```sql
CAST(DATE_FORMAT(CONVERT_TZ(created_at, '+00:00', '+08:00'), '%Y-%m-%d %H:%i:%s') AS CHAR) as created_at
```

**优点**：从源头解决，确保返回的就是字符串
**缺点**：SQL 稍微复杂一点

### 方案 2：JavaScript 后处理（备用）

在返回数据前手动转换：

```javascript
const formattedRows = rows.map(row => ({
  ...row,
  created_at:
    typeof row.created_at === 'string'
      ? row.created_at
      : row.created_at instanceof Date
        ? formatDate(row.created_at)
        : row.created_at,
  updated_at:
    typeof row.updated_at === 'string'
      ? row.updated_at
      : row.updated_at instanceof Date
        ? formatDate(row.updated_at)
        : row.updated_at,
}))
```

## 已修改的文件

✅ `app.js` - 第 2903-2915 行（充值记录列表查询）
✅ `app.js` - 第 2972-2992 行（充值记录详情查询）
✅ `app.js` - 第 2944-2950 行（添加了数据格式化）

## 立即执行

```bash
# 1. 重启后端服务
pm2 restart app

# 2. 测试 API 返回
curl http://localhost:3000/api/recharge/records?page=1&limit=1

# 3. 检查返回的 created_at 格式
# 应该是：2025-10-21 12:18:45
# 而不是：2025-10-21T04:18:45.000Z
```

## 验证步骤

### 1. 后端验证

使用 Postman 或 curl 测试：

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:3000/api/recharge/records
```

查看返回的 JSON：

```json
{
  "code": 200,
  "data": {
    "records": [
      {
        "id": 8,
        "created_at": "2025-10-21 12:18:45", // ✅ 应该是这个格式
        "updated_at": "2025-10-21 12:18:50"
      }
    ]
  }
}
```

### 2. 前端验证

打开浏览器控制台，查看网络请求：

1. F12 打开开发者工具
2. 切换到 Network 标签
3. 刷新充值记录页面
4. 找到 `recharge/records` 请求
5. 查看 Response：

```json
{
  "records": [
    {
      "created_at": "2025-10-21 12:18:45" // ✅ 正确
    }
  ]
}
```

如果还是 `"created_at": "2025-10-21T04:18:45.000Z"`，说明需要进一步排查。

## 排查清单

如果修复后还有问题：

- [ ] 确认后端服务已重启
- [ ] 确认修改的代码已生效
- [ ] 检查 mysql2 驱动版本
- [ ] 检查数据库连接配置的 `timezone` 参数
- [ ] 检查 SQL 查询是否正确执行
- [ ] 使用数据库客户端直接运行 SQL 查看结果类型

## 技术说明

### MySQL 时间处理流程

```
原始数据 (UTC)
    ↓
CONVERT_TZ(..., '+00:00', '+08:00')  // 转换为东八区
    ↓
DATE_FORMAT(..., '%Y-%m-%d %H:%i:%s')  // 格式化
    ↓
CAST(... AS CHAR)  // 强制转换为字符串 ⭐ 关键步骤
    ↓
mysql2 驱动接收（作为字符串）
    ↓
Express JSON 序列化（保持字符串）
    ↓
前端接收：'2025-10-21 12:18:45'
```

### 为什么需要 CAST

```sql
-- 没有 CAST
DATE_FORMAT(created_at, '%Y-%m-%d %H:%i:%s')
-- mysql2 可能识别为：new Date('2025-10-21 12:18:45')
-- JSON.stringify() 后：'2025-10-21T04:18:45.000Z'

-- 使用 CAST
CAST(DATE_FORMAT(created_at, '%Y-%m-%d %H:%i:%s') AS CHAR)
-- mysql2 识别为：'2025-10-21 12:18:45' (string)
-- JSON.stringify() 后：'2025-10-21 12:18:45'
```

## 下一步

1. **立即重启服务**
2. **测试 API 返回**
3. **查看前端显示**
4. 如果问题解决，标记为 ✅
5. 如果问题仍存在，提供 API 返回的完整 JSON 数据

---

**时间**：2024-10-21
**状态**：等待重启验证
