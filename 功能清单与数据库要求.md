# Fresh Harvest - 功能清单与数据库要求

## 📋 已实现功能列表

### 1. ✅ 用户头像上传功能

- **功能描述**: 用户可以上传头像图片，支持 Base64 编码
- **数据库要求**:
  - 表: `users`
  - 字段: `avatar` (TEXT 类型)
  - 说明: 必须是 TEXT 类型才能存储 Base64 图片数据
- **前端页面**: `AccountSettings.vue`
- **后端接口**: `POST /api/user/avatar`

### 2. ✅ 购物车商品选择功能

- **功能描述**: 购物车商品可以单独选中/取消，支持批量结算
- **数据库要求**:
  - 表: `cart`
  - 字段: `selected` (TINYINT(1), DEFAULT 1)
  - 说明: 0=未选中，1=选中
- **前端页面**: `Cart.vue`
- **后端接口**: `PUT /api/cart/:id/select`

### 3. ✅ 评价点赞/踩功能

- **功能描述**:
  - 用户可以对商品评价进行点赞或踩
  - 点赞和踩互斥（点了赞不能踩，反之亦然）
  - 可以取消点赞/踩
  - 刷新后保持用户的操作状态
- **数据库要求**:
  - 表1: `reviews`
    - 字段: `likes` (INT, NOT NULL, DEFAULT 0) - 点赞数
    - 字段: `dislikes` (INT, NOT NULL, DEFAULT 0) - 踩数
  - 表2: `review_likes` (新建表)
    - 字段: `id` (INT, 主键, 自增)
    - 字段: `review_id` (INT, 评价ID)
    - 字段: `user_id` (INT, 用户ID)
    - 字段: `type` (TINYINT, 1=点赞, -1=踩)
    - 字段: `created_at` (TIMESTAMP)
    - 唯一索引: `unique_user_review` (review_id, user_id)
    - 索引: `idx_review_id`, `idx_user_id`
- **前端页面**:
  - `ProductDetail.vue` - 商品详情页的评价
  - `Home.vue` - 首页的客户评价
- **后端接口**:
  - `POST /api/reviews/:id/like`
  - `POST /api/reviews/:id/dislike`

### 4. ✅ 物流追踪功能

- **功能描述**: 订单发货后可以查看物流信息和追踪号
- **数据库要求**:
  - 表: `orders`
  - 字段: `tracking_number` (VARCHAR(50), DEFAULT NULL)
  - 索引: `idx_tracking_number`
- **前端页面**: `OrderDetail.vue`, `OrderList.vue`
- **后端接口**: `GET /api/orders/:id/logistics`

### 5. ✅ 用户认证与路由守卫

- **功能描述**: 购物车等页面需要登录才能访问
- **数据库要求**: 依赖 `users` 表
- **前端页面**: 所有需要登录的页面
- **路由配置**: `router/index.js` - `meta.requiresAuth`

### 6. ✅ 商品图片管理

- **功能描述**: 商品展示图片
- **数据库要求**:
  - 表: `products`
  - 字段: `image_url` (VARCHAR)
  - 注意: 字段名是 `image_url` 不是 `image`
- **前端页面**: `Shop.vue`, `ProductDetail.vue`, `Home.vue`

### 7. ✅ 订单管理完整功能

- **功能描述**: 订单创建、状态跟踪、历史记录
- **数据库要求**:
  - 表: `orders`, `order_items`, `order_status_history`
  - 索引:
    - `idx_user_status` (user_id, status)
    - `idx_user_status_created` (user_id, status, created_at)
    - `idx_product_name` (order_items 表)
    - `idx_order_created` (order_status_history 表)
- **前端页面**: `OrderList.vue`, `OrderDetail.vue`, `Checkout.vue`

### 8. ✅ 收藏夹功能

- **功能描述**: 用户可以收藏商品
- **数据库要求**:
  - 表: `favorites`
  - 索引: `idx_user_product_fav` (user_id, product_id)
- **前端页面**: `Favorites.vue`

### 9. ✅ 地址管理

- **功能描述**: 用户可以管理收货地址
- **数据库要求**:
  - 表: `addresses`
  - 索引: `idx_user_id`, `idx_is_default`
- **前端页面**: `AddressManagement.vue`, `Checkout.vue`

### 10. ✅ 首页轮播图

- **功能描述**: 首页展示轮播广告
- **数据库要求**:
  - 表: `banners`
- **前端页面**: `Home.vue`

## 🗄️ 数据库完整性检查

### 必需的表 (12个)

1. ✅ `users` - 用户表
2. ✅ `products` - 商品表
3. ✅ `categories` - 分类表
4. ✅ `orders` - 订单表
5. ✅ `order_items` - 订单项表
6. ✅ `order_status_history` - 订单状态历史表
7. ✅ `cart` - 购物车表
8. ✅ `favorites` - 收藏表
9. ✅ `reviews` - 评价表
10. ✅ `review_likes` - 评价点赞表 **（重要！新增）**
11. ✅ `addresses` - 地址表
12. ✅ `banners` - 轮播图表

### 关键字段修改

- `users.avatar` → TEXT 类型
- `cart.selected` → TINYINT(1) DEFAULT 1
- `reviews.likes` → INT NOT NULL DEFAULT 0
- `reviews.dislikes` → INT NOT NULL DEFAULT 0
- `orders.tracking_number` → VARCHAR(50)
- `products.image_url` → VARCHAR (注意不是 `image`)

### 重要索引

- `orders`: idx_tracking_number, idx_user_status, idx_user_status_created
- `cart`: idx_user_product
- `favorites`: idx_user_product_fav
- `products`: idx_sales_count
- `order_items`: idx_product_name
- `order_status_history`: idx_order_created
- `review_likes`: unique_user_review, idx_review_id, idx_user_id

## 📝 SQL 脚本文件说明

### 检查脚本

- **`database-complete-check.sql`** - 完整的数据库结构检查脚本
  - 检查所有必需的表
  - 检查关键字段类型
  - 检查索引是否存在
  - 检查数据完整性

### 修复脚本

- **`database-complete-fix.sql`** - 完整的数据库修复脚本
  - 修复所有缺失的字段
  - 创建缺失的表
  - 添加所有必需的索引
  - 生成测试数据（物流单号）

### 其他脚本

- `database-update.sql` - 数据库升级脚本（带检查逻辑）
- `database-optimization.sql` - 性能优化脚本
- `create-review-likes-table.sql` - 单独创建 review_likes 表
- `database-cart-selected-fix.sql` - 单独修复购物车选择字段
- `update-product-images.sql` - 更新商品图片链接

## 🚀 数据库恢复步骤

### 1. 运行检查脚本

```bash
# 在 phpMyAdmin 或 MySQL 客户端执行
database-complete-check.sql
```

### 2. 运行修复脚本

```bash
# 在 phpMyAdmin 或 MySQL 客户端执行
database-complete-fix.sql
```

### 3. 验证修复结果

```bash
# 再次运行检查脚本确认所有问题已解决
database-complete-check.sql
```

### 4. 重启后端服务

```bash
node app.js
```

### 5. 测试功能

- ✅ 登录/注册
- ✅ 上传头像
- ✅ 浏览商品
- ✅ 添加购物车
- ✅ 选择购物车商品
- ✅ 提交订单
- ✅ 查看物流
- ✅ 评价商品
- ✅ 点赞/踩评价
- ✅ 收藏商品
- ✅ 管理地址

## ⚠️ 常见问题

### Q1: avatar 字段太小导致上传失败

**解决方案**: 运行 `database-complete-fix.sql` 将字段改为 TEXT 类型

### Q2: 购物车选择功能报错

**解决方案**: 运行 `database-complete-fix.sql` 添加 `selected` 字段

### Q3: 评价点赞功能不工作

**解决方案**:

1. 运行 `database-complete-fix.sql` 创建 `review_likes` 表
2. 确保 `reviews` 表有 `likes` 和 `dislikes` 字段

### Q4: 商品图片更新失败

**解决方案**: 确认使用 `image_url` 字段名，不是 `image`

### Q5: 性能问题

**解决方案**: 运行 `database-optimization.sql` 添加所有索引

## 📊 UI组件使用

### Element Plus 组件

- ✅ 所有按钮使用 `el-button` 原生组件
- ✅ 表单使用 `el-form`, `el-input`, `el-select` 等
- ✅ 图标使用 `@element-plus/icons-vue`
- ✅ 消息提示使用 `ElMessage`, `ElMessageBox`

### 已删除的无用组件

- ❌ `Header.vue` (已被 `Breadcrumb.vue` 替代)
- ❌ `ProductCard.vue` (未使用)

## 🎨 页面样式优化

### 已优化页面

- ✅ `Login.vue` - 登录注册页面（使用 Element Plus 样式）
- ✅ `Cart.vue` - 购物车页面（使用 Element Plus 按钮）
- ✅ `Shop.vue` - 商品列表页面（修复描述显示问题）
- ✅ `ProductDetail.vue` - 商品详情页面（评价互动功能）
- ✅ `Home.vue` - 首页（客户评价互动功能）
- ✅ `Checkout.vue` - 结算页面
- ✅ `OrderDetail.vue` - 订单详情页面
- ✅ `NotFound.vue` - 404页面

所有页面都已使用 Element Plus 原生按钮样式，确保UI一致性！
