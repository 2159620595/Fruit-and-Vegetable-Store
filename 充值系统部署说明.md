# 充值系统部署说明

## 🎯 部署步骤

### 1. 数据库配置

#### 执行数据库脚本

```bash
# 连接到MySQL数据库
mysql -u root -p fresh_harvest

# 执行充值系统数据库脚本
source database-recharge-system.sql;
```

#### 验证表结构

```sql
-- 检查新增的表
SHOW TABLES LIKE '%recharge%';
SHOW TABLES LIKE '%balance%';
SHOW TABLES LIKE '%membership%';

-- 检查用户表新增字段
DESCRIBE users;
```

### 2. 后端API部署

#### 更新现有后端

```bash
# 备份现有app.js
cp app.js app.js.backup

# 使用新的app.js（已包含充值系统）
# 文件已更新，包含以下新增接口：
```

#### 新增的API接口

```
GET    /api/recharge/amounts           - 获取充值金额配置
POST   /api/recharge/create            - 创建充值订单
POST   /api/recharge/confirm           - 确认充值支付
GET    /api/recharge/records           - 获取充值记录
GET    /api/recharge/transactions      - 获取余额变动记录
GET    /api/recharge/balance           - 获取用户余额信息
GET    /api/recharge/membership-levels - 获取会员等级信息
POST   /api/recharge/pay-with-balance  - 使用余额支付订单
POST   /api/recharge/refund            - 申请退款
```

#### 更新的API接口

```
GET    /api/user/profile               - 新增余额和会员等级字段
POST   /api/orders/:id/pay             - 新增余额支付支持
```

### 3. 前端部署

#### 新增文件

- `src/api/recharge.js` - 充值相关API调用
- 更新 `src/stores/userStore.js` - 新增余额管理功能
- 更新 `src/views/Profile.vue` - 新增余额显示和充值功能

#### 更新现有文件

- `src/views/Profile.vue` - 个人信息面板显示余额
- `src/stores/userStore.js` - 集成余额管理

### 4. 启动服务

#### 后端服务

```bash
# 启动后端服务
node app.js

# 或使用PM2
pm2 start app.js --name "fresh-harvest-api"
```

#### 前端服务

```bash
# 启动前端开发服务器
npm run dev

# 或构建生产版本
npm run build
```

## 🔧 配置说明

### 数据库配置

- **充值金额配置表**：`recharge_amounts`
- **充值记录表**：`recharge_records`
- **余额变动表**：`balance_transactions`
- **会员等级表**：`membership_levels`
- **用户表更新**：新增 `balance`、`membership_level`、`total_recharge` 字段

### 支付配置

- **余额支付**：使用存储过程 `sp_process_balance_payment`
- **第三方支付**：需要配置实际的支付接口
- **支付回调**：需要配置支付成功回调处理

### 会员等级配置

```sql
-- 默认会员等级
普通会员: 0元 - 无折扣
白银会员: 500元 - 9.5折
黄金会员: 2000元 - 9折
钻石会员: 5000元 - 8.5折
```

## 🧪 测试验证

### 1. 数据库测试

```sql
-- 测试充值金额配置
SELECT * FROM recharge_amounts;

-- 测试会员等级配置
SELECT * FROM membership_levels;

-- 测试用户余额信息视图
SELECT * FROM v_user_balance_info LIMIT 5;
```

### 2. API测试

```bash
# 测试获取充值金额配置
curl -X GET http://localhost:3000/api/recharge/amounts

# 测试获取用户余额信息（需要登录token）
curl -X GET http://localhost:3000/api/recharge/balance \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试创建充值订单
curl -X POST http://localhost:3000/api/recharge/create \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"amount": 100, "payment_method": "alipay"}'
```

### 3. 前端功能测试

1. **余额显示**：检查个人中心是否显示账户余额
2. **充值功能**：测试充值流程是否正常
3. **余额支付**：测试使用余额支付订单
4. **会员升级**：测试充值后会员等级是否自动升级

## 🚨 注意事项

### 安全考虑

1. **支付安全**：生产环境需要集成真实的支付接口
2. **数据验证**：所有充值金额和支付状态都需要验证
3. **事务处理**：使用数据库事务确保数据一致性
4. **权限控制**：确保只有用户本人可以操作自己的余额

### 性能优化

1. **数据库索引**：已为常用查询字段添加索引
2. **连接池**：使用MySQL连接池提高性能
3. **缓存策略**：可以考虑缓存用户余额信息
4. **分页查询**：所有列表查询都支持分页

### 监控告警

1. **支付异常**：监控支付失败率
2. **余额异常**：监控余额变动异常
3. **系统性能**：监控API响应时间
4. **数据库性能**：监控数据库查询性能

## 📊 功能特性

### 已实现功能

- ✅ 用户余额管理
- ✅ 充值功能（支持多种支付方式）
- ✅ 余额支付订单
- ✅ 会员等级自动升级
- ✅ 充值记录查询
- ✅ 余额变动记录
- ✅ 退款功能
- ✅ 响应式用户界面

### 后续优化

- 🔄 集成真实支付接口
- 🔄 添加支付安全验证
- 🔄 优化数据库查询性能
- 🔄 添加数据分析功能
- 🔄 支持更多支付方式

## 🆘 故障排除

### 常见问题

1. **数据库连接失败**：检查数据库配置和网络连接
2. **API调用失败**：检查token是否有效和API路径是否正确
3. **余额显示异常**：检查用户表是否有balance字段
4. **充值失败**：检查充值记录表和触发器是否正常

### 日志查看

```bash
# 查看后端日志
tail -f logs/app.log

# 查看PM2日志
pm2 logs fresh-harvest-api

# 查看数据库日志
tail -f /var/log/mysql/error.log
```

## 📞 技术支持

如有问题，请检查：

1. 数据库表结构是否正确创建
2. API接口是否正常启动
3. 前端代码是否正确更新
4. 网络连接是否正常

部署完成后，您的系统将支持完整的充值、余额支付和会员等级功能！
