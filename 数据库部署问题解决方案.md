# 数据库部署问题解决方案

## 🚨 问题描述

执行 `database-recharge-system.sql` 时出现错误：

```
#1060 - Duplicate column name 'balance'
```

## 🔍 问题原因

数据库中已经存在 `balance` 字段，不能重复添加。

## ✅ 解决方案

### 方案一：使用简化版脚本（推荐）

使用 `database-recharge-system-simple.sql` 脚本，它只添加缺失的字段：

```bash
# 执行简化版脚本
mysql -u root -p fresh_harvest < database-recharge-system-simple.sql
```

### 方案二：手动检查并添加缺失字段

1. **检查当前用户表结构**：

```sql
DESCRIBE users;
```

2. **只添加缺失的字段**：

```sql
-- 如果 membership_level 字段不存在，添加它
ALTER TABLE users ADD COLUMN membership_level VARCHAR(20) DEFAULT '普通会员' COMMENT '会员等级';

-- 如果 total_recharge 字段不存在，添加它
ALTER TABLE users ADD COLUMN total_recharge DECIMAL(10,2) DEFAULT 0.00 COMMENT '累计充值金额';
```

3. **然后执行其他表的创建**：

```sql
-- 创建充值记录表
CREATE TABLE IF NOT EXISTS recharge_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    amount DECIMAL(10,2) NOT NULL COMMENT '充值金额',
    bonus_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT '赠送金额',
    total_amount DECIMAL(10,2) NOT NULL COMMENT '实际到账金额',
    payment_method VARCHAR(20) NOT NULL COMMENT '支付方式: alipay, wechat, bank',
    payment_status ENUM('pending', 'success', 'failed', 'cancelled') DEFAULT 'pending' COMMENT '支付状态',
    transaction_id VARCHAR(100) COMMENT '第三方交易ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_payment_status (payment_status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='充值记录表';
```

### 方案三：使用检查脚本

1. **先运行检查脚本**：

```bash
mysql -u root -p fresh_harvest < check-database-structure.sql
```

2. **根据检查结果，只执行需要的部分**

## 📋 部署步骤

### 1. 检查当前数据库状态

```sql
-- 检查用户表字段
SELECT COLUMN_NAME, DATA_TYPE, COLUMN_DEFAULT, COLUMN_COMMENT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
AND TABLE_NAME = 'users'
AND COLUMN_NAME IN ('balance', 'membership_level', 'total_recharge');
```

### 2. 执行简化版脚本

```bash
mysql -u root -p fresh_harvest < database-recharge-system-simple.sql
```

### 3. 验证部署结果

```sql
-- 检查表是否创建成功
SHOW TABLES LIKE '%recharge%';
SHOW TABLES LIKE '%balance%';
SHOW TABLES LIKE '%membership%';

-- 检查用户表字段
DESCRIBE users;

-- 检查视图
SHOW CREATE VIEW v_user_balance_info;

-- 检查存储过程
SHOW PROCEDURE STATUS WHERE Db = DATABASE();
```

## 🔧 如果仍有问题

### 1. 检查MySQL版本

```sql
SELECT VERSION();
```

### 2. 检查字符集

```sql
SHOW VARIABLES LIKE 'character_set%';
```

### 3. 检查存储引擎

```sql
SHOW ENGINES;
```

## 📝 注意事项

1. **备份数据**：执行任何数据库修改前，请先备份数据
2. **权限检查**：确保数据库用户有足够的权限执行DDL操作
3. **字符集**：确保使用utf8mb4字符集
4. **存储引擎**：确保使用InnoDB存储引擎

## 🚀 快速解决命令

如果您想快速解决问题，请按以下顺序执行：

```bash
# 1. 备份数据库（可选但推荐）
mysqldump -u root -p fresh_harvest > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. 执行简化版脚本
mysql -u root -p fresh_harvest < database-recharge-system-simple.sql

# 3. 验证结果
mysql -u root -p fresh_harvest -e "SHOW TABLES LIKE '%recharge%';"
```

## 📞 如果问题持续存在

如果按照上述步骤仍然有问题，请：

1. 提供完整的错误信息
2. 提供当前数据库表结构
3. 提供MySQL版本信息

这样我可以提供更具体的解决方案。
