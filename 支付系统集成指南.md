# 支付系统集成指南

## 概述

本文档说明如何将余额支付功能集成到现有的支付系统中，支持用户使用账户余额购买商品。

## 数据库配置

### 1. 执行数据库脚本

```bash
# 执行充值系统数据库脚本
mysql -u username -p database_name < database-recharge-system.sql
```

### 2. 验证表结构

确保以下表已创建：

- `recharge_records` - 充值记录表
- `balance_transactions` - 余额变动记录表
- `membership_levels` - 会员等级配置表
- `recharge_amounts` - 充值金额配置表

## 后端API集成

### 1. 添加充值路由

在您的主应用中添加充值路由：

```javascript
const rechargeRoutes = require('./backend-recharge-routes')
app.use('/api/recharge', rechargeRoutes)
```

### 2. 更新订单支付逻辑

在订单支付处理中添加余额支付选项：

```javascript
// 在订单支付API中添加余额支付逻辑
router.post('/orders/:id/pay', authenticateUser, async (req, res) => {
  try {
    const { payment_method, use_balance } = req.body
    const orderId = req.params.id
    const userId = req.userId

    // 获取订单信息
    const order = await getOrderById(orderId, userId)

    if (use_balance) {
      // 使用余额支付
      const result = await db.execute(
        `
        CALL sp_process_balance_payment(?, ?, ?, ?)
      `,
        [userId, order.total_amount, orderId, `订单支付: ${order.order_number}`]
      )

      // 更新订单状态
      await updateOrderPaymentStatus(orderId, 'paid', 'balance')

      res.json({
        code: 200,
        message: '余额支付成功',
        data: result[0][0],
      })
    } else {
      // 其他支付方式处理...
    }
  } catch (error) {
    if (error.message === '余额不足') {
      res.status(400).json({
        code: 400,
        message: '余额不足',
      })
    } else {
      res.status(500).json({
        code: 500,
        message: '支付失败',
      })
    }
  }
})
```

## 前端集成

### 1. 更新支付组件

在支付对话框中添加余额支付选项：

```vue
<template>
  <div class="payment-methods">
    <h4>选择支付方式</h4>
    <div class="payment-options">
      <!-- 余额支付选项 -->
      <div
        class="payment-option"
        :class="{ active: selectedPayment === 'balance' }"
        @click="selectPaymentMethod('balance')"
      >
        <div class="payment-info">
          <el-icon><Wallet /></el-icon>
          <span>余额支付</span>
        </div>
        <div class="balance-info">
          <span class="balance-label">可用余额：</span>
          <span class="balance-amount">¥{{ userBalance.toFixed(2) }}</span>
        </div>
      </div>

      <!-- 其他支付方式... -->
    </div>
  </div>
</template>

<script setup>
import { useUserStore } from '@/stores/userStore'

const userStore = useUserStore()
const userBalance = computed(() => userStore.balance || 0)

const selectPaymentMethod = method => {
  selectedPayment.value = method
  if (method === 'balance') {
    // 检查余额是否足够
    if (userBalance.value < orderTotal.value) {
      ElMessage.warning('余额不足，请选择其他支付方式或充值')
      return
    }
  }
}
</script>
```

### 2. 更新订单支付逻辑

在订单支付处理中调用余额支付API：

```javascript
// 在订单支付方法中
const processPayment = async () => {
  try {
    if (selectedPayment.value === 'balance') {
      // 使用余额支付
      const result = await userStore.payWithBalance(
        orderId.value,
        orderTotal.value,
        `订单支付: ${orderNumber.value}`
      )

      ElMessage.success('支付成功！')
      // 跳转到支付成功页面
      router.push(`/orders/${orderId.value}`)
    } else {
      // 其他支付方式处理...
    }
  } catch (error) {
    ElMessage.error(error.message || '支付失败')
  }
}
```

## 功能特性

### 1. 余额管理

- ✅ 用户余额显示
- ✅ 充值功能
- ✅ 余额支付
- ✅ 余额变动记录
- ✅ 自动会员等级升级

### 2. 支付方式

- ✅ 余额支付
- ✅ 支付宝支付
- ✅ 微信支付
- ✅ 银行卡支付

### 3. 会员系统

- ✅ 四级会员等级
- ✅ 充值升级
- ✅ 购物升级
- ✅ 会员特权

## 测试建议

### 1. 充值功能测试

```javascript
// 测试充值流程
1. 创建充值订单
2. 模拟支付成功
3. 验证余额更新
4. 验证会员等级升级
```

### 2. 余额支付测试

```javascript
// 测试余额支付
1. 创建测试订单
2. 选择余额支付
3. 验证余额扣减
4. 验证订单状态更新
```

### 3. 边界情况测试

- 余额不足时的处理
- 充值失败的回滚
- 并发支付的处理
- 网络异常的处理

## 安全考虑

### 1. 数据验证

- 充值金额验证
- 支付状态验证
- 用户权限验证

### 2. 事务处理

- 使用数据库事务确保数据一致性
- 支付失败时的回滚机制

### 3. 日志记录

- 记录所有余额变动
- 记录支付操作日志
- 异常情况日志

## 部署注意事项

1. **数据库备份**：部署前备份现有数据
2. **API版本**：确保API版本兼容
3. **环境配置**：配置正确的数据库连接
4. **监控告警**：设置支付异常监控

## 后续优化

1. **支付安全**：集成第三方支付安全验证
2. **性能优化**：优化数据库查询性能
3. **用户体验**：添加支付进度提示
4. **数据分析**：添加支付数据统计功能
