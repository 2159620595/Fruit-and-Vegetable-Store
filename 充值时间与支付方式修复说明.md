# 充值时间与支付方式显示问题修复说明

## 问题描述

用户反馈个人中心的充值记录存在以下问题：
1. **充值时间不一致** - 显示的充值时间与实际充值的时间不一致
2. **支付方式显示问题** - 支付方式显示不正确或显示为英文代码

## 问题原因分析

### 1. 时间显示问题

**根本原因**：
- MySQL 的 `TIMESTAMP` 类型默认存储 UTC 时间
- 数据库连接配置中没有设置时区参数
- 后端返回数据时没有进行时区转换
- 前端在格式化时间时也没有考虑时区问题

**导致结果**：
- 数据库存储的是 UTC 时间（比中国时间晚8小时）
- 前端显示时可能显示为 UTC 时间，与实际充值时间相差8小时

### 2. 支付方式显示问题

**根本原因**：
- 数据库存储的支付方式是英文代码（如 'alipay', 'wechat'）
- 前端映射表不完整，没有覆盖所有可能的支付方式变体
- 支付方式可能有大小写不一致的问题

**导致结果**：
- 某些支付方式显示为英文代码而非中文名称
- 新增的支付方式没有对应的中文映射

## 修复方案

### 1. 后端修复（app.js）

#### 1.1 数据库连接配置

**修改位置**：`app.js` 第21-31行

**修改内容**：
```javascript
const pool = mysql.createPool({
  host: process.env.DB_HOST || '120.78.238.149',
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || '123456',
  database: process.env.DB_NAME || 'fresh_harvest',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
  charset: 'utf8mb4',
  timezone: '+08:00', // ✅ 新增：设置为中国标准时间（东八区）
})
```

**作用**：确保所有数据库连接使用东八区时区

#### 1.2 充值记录列表查询

**修改位置**：`app.js` 第2903-2915行

**修改内容**：
```javascript
const [rows] = await pool.query(
  `
  SELECT id, amount, bonus_amount, total_amount, payment_method, 
         payment_status, transaction_id, 
         DATE_FORMAT(CONVERT_TZ(created_at, '+00:00', '+08:00'), '%Y-%m-%d %H:%i:%s') as created_at,
         DATE_FORMAT(CONVERT_TZ(updated_at, '+00:00', '+08:00'), '%Y-%m-%d %H:%i:%s') as updated_at
  FROM recharge_records 
  ${whereClause}
  ORDER BY created_at ${orderDirection}
  LIMIT ? OFFSET ?
`,
  [...params, parseInt(limit), offset]
)
```

**作用**：
- 使用 `CONVERT_TZ` 函数将 UTC 时间转换为东八区时间
- 使用 `DATE_FORMAT` 格式化时间为标准格式 `YYYY-MM-DD HH:mm:ss`

#### 1.3 充值记录详情查询

**修改位置**：`app.js` 第2972-2992行

**修改内容**：
```javascript
const [[record]] = await pool.query(
  `
  SELECT 
    r.id,
    r.user_id,
    r.amount,
    r.bonus_amount,
    r.total_amount,
    r.payment_method,
    r.payment_status,
    r.transaction_id,
    DATE_FORMAT(CONVERT_TZ(r.created_at, '+00:00', '+08:00'), '%Y-%m-%d %H:%i:%s') as created_at,
    DATE_FORMAT(CONVERT_TZ(r.updated_at, '+00:00', '+08:00'), '%Y-%m-%d %H:%i:%s') as updated_at,
    u.username,
    u.balance as current_balance
  FROM recharge_records r
  LEFT JOIN users u ON r.user_id = u.id
  WHERE r.id = ? AND r.user_id = ?
`,
  [id, userId]
)
```

**作用**：确保详情页面也显示正确的本地时间

### 2. 前端修复（src/views/Profile.vue）

#### 2.1 时间格式化函数增强

**修改位置**：`src/views/Profile.vue` 第1607-1657行

**修改内容**：
```javascript
const formatDateTime = datetime => {
  if (!datetime) return '-'

  try {
    // 处理多种日期格式
    let date
    if (typeof datetime === 'string') {
      // MySQL返回的时间格式：'YYYY-MM-DD HH:mm:ss'
      // 如果已经是正确的格式字符串，直接返回
      if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(datetime)) {
        return datetime // ✅ 直接返回格式化好的时间字符串
      }
      // 尝试解析为Date对象
      date = new Date(datetime.replace(/-/g, '/')) // 兼容Safari浏览器
    } else if (datetime instanceof Date) {
      date = datetime
    } else if (typeof datetime === 'number') {
      date = new Date(datetime)
    } else {
      console.warn('未知的日期格式:', datetime, typeof datetime)
      return '-'
    }

    // 检查日期是否有效
    if (isNaN(date.getTime())) {
      console.error('无效的日期:', datetime)
      return datetime.toString()
    }

    // 格式化为本地时间
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    const hours = String(date.getHours()).padStart(2, '0')
    const minutes = String(date.getMinutes()).padStart(2, '0')
    const seconds = String(date.getSeconds()).padStart(2, '0')

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
  } catch (error) {
    console.error('日期格式化错误:', error, datetime)
    return datetime?.toString() || '-'
  }
}
```

**优化点**：
- 检测后端返回的格式化字符串，直接返回避免二次转换
- 增强错误处理，避免显示异常
- 兼容 Safari 浏览器的日期解析

#### 2.2 支付方式映射增强

**修改位置**：`src/views/Profile.vue` 第1659-1705行

**修改内容**：
```javascript
const getPaymentMethodName = method => {
  if (!method) return '-'

  const methods = {
    // 小写形式
    alipay: '支付宝',
    wechat: '微信支付',
    wechatpay: '微信支付',
    bank: '银行卡',
    bank_card: '银行卡',
    balance: '余额支付',
    credit_card: '信用卡',
    bank_transfer: '银行转账',
    cash_on_delivery: '货到付款',
    unionpay: '银联支付',
    // 大写形式
    ALIPAY: '支付宝',
    WECHAT: '微信支付',
    WECHATPAY: '微信支付',
    BANK: '银行卡',
    BANK_CARD: '银行卡',
    BALANCE: '余额支付',
    CREDIT_CARD: '信用卡',
    BANK_TRANSFER: '银行转账',
    CASH_ON_DELIVERY: '货到付款',
    UNIONPAY: '银联支付',
  }

  // 统一转换为小写进行匹配
  const normalizedMethod = String(method).trim().toLowerCase()
  let result = methods[normalizedMethod]
  
  // 如果没有找到映射，尝试大写形式
  if (!result) {
    result = methods[String(method).trim().toUpperCase()]
  }
  
  // 如果还是没有找到，返回原始值
  if (!result) {
    result = method
    console.warn(`⚠️ 未知的支付方式: "${method}"，请添加映射`)
  }

  console.log(`💳 支付方式转换: "${method}" -> "${result}"`)

  return result
}
```

**优化点**：
- 扩展支付方式映射表，支持更多变体
- 同时支持大小写形式的映射
- 添加警告日志，方便发现未映射的支付方式
- 添加调试日志，便于排查问题

### 3. 数据库检查脚本

**文件**：`fix-recharge-time-payment.sql`

**功能**：
1. 检查数据库时区设置
2. 验证充值记录的时间字段
3. 检查支付方式的分布情况
4. 查找异常的时间记录
5. 提供修复建议

**使用方法**：
```bash
mysql -u root -p fresh_harvest < fix-recharge-time-payment.sql
```

## 部署步骤

### 1. 备份数据库
```bash
mysqldump -u root -p fresh_harvest > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. 重启后端服务
```bash
# 停止当前服务
pm2 stop app

# 重新启动服务
pm2 start app.js --name "fresh-harvest-api"

# 查看日志
pm2 logs app
```

### 3. 清除前端缓存
```bash
# 重新构建前端
npm run build

# 如果使用了缓存，清除浏览器缓存
# 或者强制刷新页面 (Ctrl + Shift + R)
```

### 4. 运行数据库检查脚本
```bash
mysql -u root -p fresh_harvest < fix-recharge-time-payment.sql
```

## 验证测试

### 1. 时间显示测试

**测试步骤**：
1. 进行一次充值操作
2. 记录充值的实际时间（系统时间）
3. 打开个人中心-充值记录
4. 检查最新充值记录的时间是否与实际时间一致

**预期结果**：
- 充值时间应该显示为本地时间（东八区）
- 时间误差应在1分钟以内

### 2. 支付方式显示测试

**测试步骤**：
1. 使用不同的支付方式进行充值（支付宝、微信、银行卡）
2. 打开个人中心-充值记录
3. 检查每条记录的支付方式显示

**预期结果**：
- 所有支付方式都应该显示为中文名称
- 不应该出现英文代码
- 支付方式显示正确无误

### 3. 历史记录测试

**测试步骤**：
1. 打开个人中心-充值记录
2. 查看历史充值记录
3. 检查所有记录的时间和支付方式

**预期结果**：
- 历史记录的时间应该正确显示（可能与之前显示不同，但应该是正确的本地时间）
- 所有支付方式都应该正确映射为中文名称

## 常见问题

### Q1: 为什么历史记录的时间改变了？

**A**: 因为之前显示的是 UTC 时间（比北京时间晚8小时），现在修复后显示的是正确的本地时间。例如：
- 修复前显示：2024-01-20 02:30:00（UTC 时间）
- 修复后显示：2024-01-20 10:30:00（北京时间，正确）

### Q2: 如果有未识别的支付方式怎么办？

**A**: 
1. 查看浏览器控制台，会有警告日志显示未识别的支付方式
2. 在 `src/views/Profile.vue` 的 `getPaymentMethodName` 函数中添加新的映射
3. 格式：`'新支付方式代码': '中文名称'`

### Q3: 如何验证修复是否生效？

**A**:
1. 打开浏览器控制台（F12）
2. 打开个人中心-充值记录
3. 查看控制台日志：
   - `📝 充值记录样例数据:` - 显示原始数据
   - `💳 支付方式转换:` - 显示支付方式映射过程
4. 确认时间和支付方式显示正确

## 注意事项

1. **时区设置**：确保服务器和数据库的时区设置一致
2. **数据备份**：修改前务必备份数据库
3. **缓存清理**：部署后建议清除浏览器缓存
4. **兼容性**：修复方案向后兼容，不影响现有数据

## 技术细节

### 时区转换说明

```sql
CONVERT_TZ(created_at, '+00:00', '+08:00')
```

- 第一个参数：待转换的时间字段
- 第二个参数：源时区（+00:00 表示 UTC）
- 第三个参数：目标时区（+08:00 表示东八区）

### 日期格式化说明

```sql
DATE_FORMAT(datetime, '%Y-%m-%d %H:%i:%s')
```

- `%Y`：四位年份（2024）
- `%m`：两位月份（01-12）
- `%d`：两位日期（01-31）
- `%H`：24小时制小时（00-23）
- `%i`：分钟（00-59）
- `%s`：秒（00-59）

## 维护建议

1. **定期检查**：每月运行一次数据库检查脚本，确保数据正常
2. **日志监控**：关注支付方式映射的警告日志，及时添加新的映射
3. **时区一致**：确保所有服务器（应用服务器、数据库服务器）使用相同的时区
4. **文档更新**：新增支付方式时，更新本文档的映射表

## 更新历史

- 2024-01-20：初始版本，修复时间和支付方式显示问题

---

如有问题，请查看浏览器控制台日志或联系技术支持。

